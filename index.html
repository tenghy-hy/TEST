<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ¥è­˜ç‹ KING - 10é¡ŒæŒ‘æˆ°</title>
    <style>
        :root { --main: #6c5ce7; --bg: #f0f2f5; --win: #00b894; --lose: #d63031; --gold: #f1c40f; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        #game-box { background: white; width: 95%; max-width: 450px; padding: 25px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; }
        #timer-bg { width: 100%; height: 12px; background: #eee; border-radius: 6px; overflow: hidden; margin: 20px 0; }
        #timer-fill { width: 100%; height: 100%; background: var(--main); transition: width 0.1s linear; }
        .q-text { font-size: 1.2em; font-weight: bold; margin-bottom: 20px; min-height: 60px; color: #2d3436; line-height: 1.5; }
        .options-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .opt-btn { padding: 14px; border: 2px solid #e0e0e0; border-radius: 12px; background: white; cursor: pointer; font-size: 1.1em; transition: 0.2s; outline: none; }
        .correct { background: var(--win) !important; color: white; border-color: var(--win); }
        .wrong { background: var(--lose) !important; color: white; border-color: var(--lose); }
        .hidden { display: none; }
        #rank-box { margin-top: 20px; background: #f8f9fa; border-radius: 15px; padding: 15px; text-align: left; border: 1px solid #e0e0e0; }
        .rank-item { display: flex; justify-content: space-between; padding: 8px 5px; border-bottom: 1px dashed #ccc; font-weight: bold; }
        .rank-item.top1 { color: #d35400; background: #fff9db; border-radius: 5px; }
        select#player-no { width: 100%; padding: 12px; font-size: 1.1em; border-radius: 10px; border: 2px solid var(--main); margin-bottom: 20px; outline: none; }
        button#start-btn { padding: 15px 40px; font-size: 1.2em; background: var(--main); color: white; border: none; border-radius: 50px; cursor: pointer; }
        button#start-btn:disabled { background: #ccc; }
    </style>
</head>
<body>

<div id="game-box">
    <div id="start-screen">
        <h1>çŸ¥è­˜ç‹ KING</h1>
        <p>éš¨æ©ŸæŠ½å– 10 é¡Œé€²è¡ŒæŒ‘æˆ°</p>
        <select id="player-no">
            <option value="" disabled selected>-- é¸æ“‡åº§è™Ÿ --</option>
        </select>
        <button id="start-btn" onclick="initGame()" disabled>é¡Œåº«è¼‰å…¥ä¸­...</button>
        <p id="msg" style="font-size: 0.85em; color: #666; margin-top: 15px;"></p>
    </div>

    <div id="quiz-area" class="hidden">
        <div style="display:flex; justify-content:space-between; font-weight:bold; color:var(--main);">
            <span id="q-count">0/10</span>
            <span id="score-text">å¾—åˆ†: 0</span>
        </div>
        <div id="timer-bg"><div id="timer-fill"></div></div>
        <div id="q-text" class="q-text"></div>
        <div class="options-grid" id="options-area">
            <button class="opt-btn" onclick="checkAnswer(0)"></button>
            <button class="opt-btn" onclick="checkAnswer(1)"></button>
            <button class="opt-btn" onclick="checkAnswer(2)"></button>
            <button class="opt-btn" onclick="checkAnswer(3)"></button>
        </div>
    </div>

    <div id="end-screen" class="hidden">
        <h2>ğŸ‰ æŒ‘æˆ°å®Œæˆ</h2>
        <h1 id="final-score" style="font-size: 3.5em; color: var(--main); margin: 0;">0</h1>
        <p id="upload-status" style="font-weight:bold; color:#e67e22;">æˆç¸¾ç´€éŒ„ä¸­...</p>
        <div id="rank-box">
            <div style="text-align:center; font-weight:bold; color:var(--main); margin-bottom:10px;">ğŸ† å‰äº”åæ’è¡Œ</div>
            <div id="rank-content" style="font-size: 0.95em;">è¼‰å…¥æ’è¡Œä¸­...</div>
        </div>
        <button onclick="location.reload()" style="margin-top:20px; padding:12px 30px; border-radius:50px; border:none; background:var(--main); color:white; font-size:1em; cursor:pointer;">å›ä¸»ç•«é¢</button>
    </div>
</div>

<script>
    const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTaKApjd61Cc4pPeBW3gBknoHdaCkKavZnjSriMPVnWSNx6tbQyksw4fX9DDEo6zlSevqNQ4vvPkqMl/pub?gid=1437660801&single=true&output=csv";
    const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLScOCC3XH910Aj2izzG6Un-9P0y5g8KlbrCDxd1-LvsT1uSRow/formResponse";
    const ID_NO = "entry.380705505";
    const ID_SCORE = "entry.330260248";
    const RANK_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS5zUnJgXdBNUHfIcgtktxutd4Jls3fwf48I9KXK4XNwNMpuXcRXfzNaKjCH35mbHBMwucKSYVKc3w9/pub?output=csv";

    let allQuestions = []; // å­˜å„²åŸå§‹é¡Œåº«
    let gameQuestions = []; // å­˜å„²æŠ½å–çš„10é¡Œ
    let currentIdx = 0, score = 0, timer, timeLeft = 100, currentCorrectIdx = 0;

    const sel = document.getElementById('player-no');
    for(let i=1; i<=36; i++){
        let o = document.createElement('option');
        o.value = i; o.textContent = i + " è™Ÿ";
        sel.appendChild(o);
    }

    async function loadQuestions() {
        try {
            const res = await fetch(SHEET_CSV + "?t=" + Date.now());
            const text = await res.text();
            const lines = text.split(/\r?\n/);
            const temp = [];
            lines.forEach(line => {
                const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/^"|"$/g, '').trim());
                const map = {'A':0, 'B':1, 'C':2, 'D':3};
                if (cols.length >= 6 && map.hasOwnProperty(cols[1].toUpperCase())) {
                    temp.push({ q: cols[0], opts: [cols[2], cols[3], cols[4], cols[5]], a: map[cols[1].toUpperCase()] });
                }
            });
            allQuestions = temp;
            document.getElementById('start-btn').disabled = false;
            document.getElementById('start-btn').innerText = "é–‹å§‹æŒ‘æˆ°";
            document.getElementById('msg').innerText = "âœ… é¡Œåº«å·²æº–å‚™å¥½ " + allQuestions.length + " é¡Œ";
        } catch (e) {
            document.getElementById('msg').innerText = "âŒ é¡Œåº«é€£ç·šå¤±æ•—";
        }
    }

    function initGame() {
        if(!sel.value) { alert("è«‹å…ˆé¸æ“‡åº§è™Ÿï¼"); return; }
        
        // éš¨æ©Ÿæ´—ç‰Œä¸¦æŠ½å– 10 é¡Œ
        gameQuestions = [...allQuestions].sort(() => Math.random() - 0.5).slice(0, 10);
        
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('quiz-area').classList.remove('hidden');
        showQuestion();
    }

    function showQuestion() {
        if (currentIdx >= gameQuestions.length) { endGame(); return; }
        const data = gameQuestions[currentIdx];
        document.getElementById('q-count').innerText = `${currentIdx+1} / 10`;
        document.getElementById('q-text').innerText = data.q;
        const combined = data.opts.map((t, i) => ({ t, isCorrect: i === data.a }));
        combined.sort(() => Math.random() - 0.5);
        const btns = document.querySelectorAll('.opt-btn');
        combined.forEach((o, i) => {
            btns[i].innerText = o.t;
            btns[i].className = 'opt-btn';
            btns[i].disabled = false;
            if (o.isCorrect) currentCorrectIdx = i;
        });
        startTimer();
    }

    function startTimer() {
        timeLeft = 100;
        clearInterval(timer);
        timer = setInterval(() => {
            timeLeft -= 2; 
            document.getElementById('timer-fill').style.width = timeLeft + "%";
            if (timeLeft <= 0) { clearInterval(timer); checkAnswer(-1); }
        }, 100);
    }

    function checkAnswer(idx) {
        clearInterval(timer);
        const btns = document.querySelectorAll('.opt-btn');
        btns.forEach(b => b.disabled = true);
        if (idx === currentCorrectIdx) {
            btns[idx].classList.add('correct');
            score += Math.max(10, Math.floor(timeLeft));
        } else {
            if (idx !== -1) btns[idx].classList.add('wrong');
            btns[currentCorrectIdx].classList.add('correct');
        }
        document.getElementById('score-text').innerText = "å¾—åˆ†: " + score;
        setTimeout(() => { currentIdx++; showQuestion(); }, 1200);
    }

    function endGame() {
        document.getElementById('quiz-area').classList.add('hidden');
        document.getElementById('end-screen').classList.remove('hidden');
        document.getElementById('final-score').innerText = score;
        const postUrl = `${FORM_URL}?${ID_NO}=${encodeURIComponent(sel.value)}&${ID_SCORE}=${score}&submit=Submit`;
        fetch(postUrl, { mode: 'no-cors' });
        document.getElementById('upload-status').innerText = "âœ… æˆç¸¾å·²å„²å­˜";
        loadRank();
    }

    async function loadRank() {
        const content = document.getElementById('rank-content');
        try {
            const res = await fetch(RANK_CSV + "?t=" + Date.now());
            const text = await res.text();
            const lines = text.split(/\r?\n/).slice(1);
            let data = lines.map(line => {
                const c = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(item => item.replace(/^"|"$/g, '').trim());
                return { name: c[1], score: parseInt(c[2]) || 0 };
            }).filter(i => i.name);
            data.sort((a, b) => b.score - a.score);
            const top5 = data.slice(0, 5);
            if(top5.length === 0) {
                content.innerText = "å°šç„¡æ’åç´€éŒ„ã€‚";
            } else {
                content.innerHTML = top5.map((item, idx) => `
                    <div class="rank-item ${idx===0?'top1':''}">
                        <span>${idx + 1}. ${item.name} è™Ÿ</span>
                        <span>${item.score} åˆ†</span>
                    </div>
                `).join('');
            }
        } catch (e) {
            content.innerText = "æ’è¡Œæ¦œåŒæ­¥ä¸­...";
        }
    }
    window.onload = loadQuestions;
</script>
</body>
</html>
