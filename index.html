<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>知識王 - 終極連線版</title>
    <style>
        :root { --main: #6c5ce7; --bg: #f0f2f5; --win: #00b894; --lose: #d63031; }
        body { font-family: sans-serif; background: var(--bg); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        #game-box { background: white; width: 90%; max-width: 450px; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; }
        #timer-bg { width: 100%; height: 10px; background: #eee; border-radius: 5px; margin: 15px 0; overflow: hidden; }
        #timer-fill { width: 100%; height: 100%; background: var(--main); transition: width 0.1s linear; }
        .q-text { font-size: 1.2em; font-weight: bold; margin-bottom: 20px; color: #2d3436; }
        .options-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .opt-btn { padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; background: white; cursor: pointer; font-size: 1em; }
        .correct { background: var(--win) !important; color: white; }
        .wrong { background: var(--lose) !important; color: white; }
        .hidden { display: none; }
        #debug-box { margin-top: 20px; padding: 10px; background: #333; color: #0f0; font-family: monospace; font-size: 11px; text-align: left; border-radius: 5px; max-height: 150px; overflow-y: auto; }
        button#start-btn { padding: 12px 30px; background: var(--main); color: white; border: none; border-radius: 20px; cursor: pointer; font-size: 1.1em; }
        button#start-btn:disabled { background: #ccc; }
    </style>
</head>
<body>

<div id="game-box">
    <div id="start-screen">
        <h1>知識王 KING</h1>
        <p id="msg">正在同步 Google 題庫...</p>
        <button id="start-btn" onclick="initGame()" disabled>等待讀取中...</button>
        <div id="debug-box">系統準備中...</div>
        <button onclick="fetchSheet()" style="margin-top:10px; font-size:10px;">手動重新連線</button>
    </div>

    <div id="quiz-area" class="hidden">
        <div style="display:flex; justify-content:space-between; font-weight:bold;">
            <span id="q-count">0/0</span>
            <span id="score-text">得分: 0</span>
        </div>
        <div id="timer-bg"><div id="timer-fill"></div></div>
        <div class="q-text" id="q-text"></div>
        <div class="options-grid" id="options-area">
            <button class="opt-btn" onclick="checkAnswer(0)"></button>
            <button class="opt-btn" onclick="checkAnswer(1)"></button>
            <button class="opt-btn" onclick="checkAnswer(2)"></button>
            <button class="opt-btn" onclick="checkAnswer(3)"></button>
        </div>
    </div>
</div>

<script>
    // 這次網址後方隨機數加強，確保不抓舊檔案
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTaKApjd61Cc4pPeBW3gBknoHdaCkKavZnjSriMPVnWSNx6tbQyksw4fX9DDEo6zlSevqNQ4vvPkqMl/pub?gid=1437660801&single=true&output=csv&v=" + Math.random();

    let questions = [];
    let currentIdx = 0, score = 0, timer, timeLeft = 100, currentCorrectIdx = 0;

    function log(text) {
        const box = document.getElementById('debug-box');
        box.innerHTML += "><br>" + text;
        box.scrollTop = box.scrollHeight;
    }

    async function fetchSheet() {
        log("開始發送 Fetch...");
        try {
            const res = await fetch(CSV_URL);
            if (!res.ok) throw new Error("網路請求失敗: " + res.status);
            
            const rawText = await res.text();
            log("收到原始資料，前50字：" + rawText.substring(0, 50));

            const lines = rawText.split(/\r?\n/);
            const temp = [];
            const answerMap = { 'A': 0, 'B': 1, 'C': 2, 'D': 3 };

            lines.forEach((line, i) => {
                const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/^"|"$/g, '').trim());
                if (cols.length >= 6) {
                    const ansKey = cols[1].toUpperCase();
                    if (answerMap.hasOwnProperty(ansKey)) {
                        temp.push({
                            q: cols[0],
                            options: [cols[2], cols[3], cols[4], cols[5]],
                            a: answerMap[ansKey]
                        });
                    }
                }
            });

            if (temp.length === 0) {
                log("❌ 解析失敗：雖然有抓到字，但沒看到 A/B/C/D 答案。");
            } else {
                questions = temp;
                log("✅ 成功解析 " + questions.length + " 題！");
                document.getElementById('msg').innerText = "連線成功！";
                const btn = document.getElementById('start-btn');
                btn.disabled = false;
                btn.innerText = "開始挑戰";
            }
        } catch (err) {
            log("❌ 連線錯誤：" + err.message);
        }
    }

    function shuffle(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    }

    function initGame() {
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('quiz-area').classList.remove('hidden');
        questions = shuffle([...questions]);
        showQuestion();
    }

    function showQuestion() {
        if (currentIdx >= questions.length) {
            document.getElementById('quiz-area').innerHTML = `<h2>挑戰結束</h2><h1>得分：${score}</h1><button onclick="location.reload()">再玩一次</button>`;
            return;
        }
        const qData = questions[currentIdx];
        document.getElementById('q-count').innerText = `${currentIdx + 1} / ${questions.length}`;
        document.getElementById('q-text').innerText = qData.q;
        const opts = qData.options.map((t, i) => ({ t, isCorrect: i === qData.a }));
        shuffle(opts);
        const btns = document.querySelectorAll('.opt-btn');
        opts.forEach((o, i) => {
            btns[i].innerText = o.t;
            btns[i].className = 'opt-btn';
            btns[i].disabled = false;
            if (o.isCorrect) currentCorrectIdx = i;
        });
        startTimer();
    }

    function startTimer() {
        timeLeft = 100;
        clearInterval(timer);
        timer = setInterval(() => {
            timeLeft -= 2; 
            document.getElementById('timer-fill').style.width = timeLeft + "%";
            if (timeLeft <= 0) { clearInterval(timer); checkAnswer(-1); }
        }, 100);
    }

    function checkAnswer(idx) {
        clearInterval(timer);
        const btns = document.querySelectorAll('.opt-btn');
        btns.forEach(b => b.disabled = true);
        if (idx === currentCorrectIdx) {
            btns[idx].classList.add('correct');
            score += Math.max(10, Math.floor(timeLeft));
        } else {
            if (idx !== -1) btns[idx].classList.add('wrong');
            btns[currentCorrectIdx].classList.add('correct');
        }
        document.getElementById('score-text').innerText = "得分: " + score;
        setTimeout(() => { currentIdx++; showQuestion(); }, 1200);
    }

    window.onload = fetchSheet;
</script>
</body>
</html>
